# NoSQLdb

![Go](https://img.shields.io/badge/Go-1.25+-00ADD8?style=flat-square&logo=go)

Лёгкая учебная документно-ориентированная NoSQL СУБД с сетевым интерфейсом и поддержкой конкурентных write-операций.

> **В проекте используются собственные реализации B+Tree и HashMap для индексов и хранения коллекций.**

---

## Возможности

- **Документная модель**: хранение коллекций JSON-документов
- **TCP-сервер**: клиент-серверная архитектура, работа по сети
- **REPL-клиент**: интерактивный режим командной строки
- **Быстрые индексы**: поддержка B+Tree-индексов по полям
- **Гибкие запросы**: операторы $eq, $gt, $lt, $in, $like, $or, $and
- **Очередь write-операций**: гарантированная последовательность изменений
- **Потокобезопасность**: конкурентный доступ к коллекциям
- **Персистентность**: хранение данных и индексов на диске

---

## Быстрый старт

1. **Запуск сервера**
   ```sh
   go run ./cmd/server/main.go
   ```
2. **Запуск клиента**
   ```sh
   go run ./cmd/client/main.go --host localhost --port 8080 --database my_database
   ```
3. **Примеры команд** — см. файл [`commands.txt`](./commands.txt)

---

## Пример работы

```
> INSERT users {"name": "Alice", "age": 25}
> FIND users {"age": {"$gt": 20}}
> DELETE users {"name": "Alice"}
> CREATE_INDEX users age
```

---

## Как работает очередь задач и воркер

- Все операции изменения (insert, delete, create_index) ставятся в очередь
- Воркер (отдельная горутина) по одной обрабатывает задачи, гарантируя целостность данных
- Каждая задача — это callback-функция, которая получает коллекцию и выполняет нужную операцию
- Результат возвращается через канал обратно вызывающему хендлеру

Подробнее — см. раздел в коде [`internal/storage/manager.go`](./internal/storage/manager.go)

---

## Архитектура

- `cmd/server/` — запуск сервера
- `cmd/client/` — интерактивный клиент
- `internal/handlers/` — обработчики команд
- `internal/storage/` — коллекции, индексы, менеджер, очередь
- `internal/query/` — парсер и типы запросов
- `internal/operators/` — сравнения и логика поиска

---

## Тестирование конкурентности

Для проверки потокобезопасности и корректности работы очереди write-операций реализованы интеграционные тесты:

- `client_concurrency_test.go` — запускает параллельные insert, delete, create_index через сетевой клиент
- Проверяет, что:
  - Все вставки проходят без потерь
  - Удаления и вставки не конфликтуют
  - Индексация не ломает данные

**Запуск тестов:**

1. Запустите сервер:
   ```sh
   go run ./cmd/server/main.go
   ```
2. В другом терминале:
   ```sh
   go test -v client_concurrency_test.go
   ```
